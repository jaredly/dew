#!/usr/bin/env node
var argv = require('minimist')(process.argv.slice(2))
  , action = argv._[0]
  , dropName = argv._[1]
  , path = require('path')
  , _ = require('lodash')
  , Dew = require('../index').Dew

var dew = new Dew({
  src: path.resolve(__dirname, '..')
});

if (action === 'list') {
  console.log("Listing drops");
  _.each(dew.drops, function (info, name) {
    console.log(" * "+name);
  });
  process.exit(0);
} else if (dropName) {
  var DewDrop = dew.drops[dropName];
  if (DewDrop) {
    var Drop = DewDrop();
    var drop = new Drop({ name: dropName })
    if (drop[action]) {
      drop[action](function (err, res) {
        if (err) throw err;
        if (res) console.log(res);
      });
    } else {
      console.log("Cannot '"+action+"' this drop");
    }
  } else {
    console.error('No drop named '+dropName);
    process.exit(1);
  }
} else help()

function help() {
  var pkg = require('../package.json');
  var _0 = path.basename(__filename);
  console.log("Dew "+pkg.version+" ( "+pkg.repository.url+" ) ")
  console.log("Usage: ")
  console.log("  "+_0+" list")
  console.log("  "+_0+" install <name>")
  console.log("  "+_0+" destroy <name>")
};
